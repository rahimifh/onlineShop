<!-- account_orders.html -->
{% extends './_DashMain.html' %}
{% block title %}
    <title>
              ساخت سورلینک
    </title>
{% endblock %}
{% load static %}
{% block customCss %}

    <link rel="stylesheet" href="{% static 'css/sorchi_btn.css' %}?=4">
    
    <link rel="stylesheet" href="{% static 'css/sorlink_maker.css' %}">
    <style>
        .edit-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: transparent;
            border: none;
            cursor: pointer;
        }

        .edit-icon:before {
            content: "\270E"; /* Unicode value for pencil symbol */
        }
    </style>
{% endblock %}
{% block content %}
    <div class="column border border-gray-400 p-10 rounded-4 bg-blur-sm bg-white">
        {% if business == False %}
            <div class="content_box">
                <p>
                    برای داشتن اکانت سورلینک نیاز است که حساب کسب و کاری خودتونو داشته باشید.
                </p>
                <div class="gradient gradient_btn">
                    <a href="{% url 'account:signupBusiness' %}" style="text-decoration: none; color:#393939">
                        ساخت حساب کسب و کار من
                    </a>
                </div>
            </div>
        {% else %}
            {% if sorlink == False %}
                <div class="center">
                    <h1> {% if error != "OK" %} {{ error }} {% endif %} </h1>
                    <div class="content_box">
                        <form action="{% url 'sh:sorlinkMaker' %}" method="post">
                            <div class="row">
                                <div class="column">
                                    <p>آدرس سورلینک باید حروف انگلیسی بدون فاصله باشد.</p>
                                    <div class="form-group" style="width: max-content;">
                                        <div class="input-group">
                                            <input type="text" name="ShortURL" class="simple_text_dark_input"
                                                   style="width: 150px; height: 35px; text-align:left; font-size:14px;"
                                                   id="">
                                            <p class="url-prefix"
                                               style="font-size:40%; font-weight: bolder; direction:ltr; margin-top: auto;">
                                                sorchi.com/back/sh/mvc/</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="column">
                                    <input type="number" name="TemId" value="1" id="" hidden>
                                    {% csrf_token %}
                                    <input class="btn btn-primary" type="submit" value="تایید">
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

            {% else %}
                <div class="card">
                    <div class="card-body" id="card">
                        <div class="row">

                            <div class="col-md-12">
                                <h2 class="card-title color-[ #ffbf00] text-center linear-background p-2">اطلاعات حساب سورلینک شما :</h2>
                            </div>
                            <div class="col-md-12">
                                <form action="{% url 'account:updateBusiness' business_id=business.id %}" method="post"
                                      id="sorlink_changer">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <div class="avatar-upload">
                                            <div class="avatar-edit">
                                                <input name="profile_image" type='file' id="imageUpload"
                                                       accept=".png, .jpg, .jpeg"/>
                                                <label for="imageUpload">
                                                    <svg class="svg-icon"
                                                         style="width: 2em; height: 2em;vertical-align: middle;fill: #393939;overflow: hidden;"
                                                         viewBox="0 0 1024 1024" version="1.1"
                                                         xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M834.3 705.7c0 82.2-66.8 149-149 149H325.9c-82.2 0-149-66.8-149-149V346.4c0-82.2 66.8-149 149-149h129.8v-42.7H325.9c-105.7 0-191.7 86-191.7 191.7v359.3c0 105.7 86 191.7 191.7 191.7h359.3c105.7 0 191.7-86 191.7-191.7V575.9h-42.7v129.8z"/>
                                                        <path d="M889.7 163.4c-22.9-22.9-53-34.4-83.1-34.4s-60.1 11.5-83.1 34.4L312 574.9c-16.9 16.9-27.9 38.8-31.2 62.5l-19 132.8c-1.6 11.4 7.3 21.3 18.4 21.3 0.9 0 1.8-0.1 2.7-0.2l132.8-19c23.7-3.4 45.6-14.3 62.5-31.2l411.5-411.5c45.9-45.9 45.9-120.3 0-166.2zM362 585.3L710.3 237 816 342.8 467.8 691.1 362 585.3zM409.7 730l-101.1 14.4L323 643.3c1.4-9.5 4.8-18.7 9.9-26.7L436.3 720c-8 5.2-17.1 8.7-26.6 10z m449.8-430.7l-13.3 13.3-105.7-105.8 13.3-13.3c14.1-14.1 32.9-21.9 52.9-21.9s38.8 7.8 52.9 21.9c29.1 29.2 29.1 76.7-0.1 105.8z"/>
                                                    </svg>
                                                </label>
                                            </div>
                                            <div class="avatar-preview">
                                                {% if business.profile_image %}
                                                    <div id="imagePreview"
                                                         style="background-image: url('{{ business.profile_image.url }}');"></div>
                                                {% else %}
                                                    <div id="imagePreview"
                                                         style="background-image: url('{% static "img/default-profile.jpg" %}');"></div>
                                                    <p id="profile-alert" style="margin-top: 10px;">شما هنوز تصویری به
                                                        عنوان لوگوی کسب و کار انتخاب نکرده اید.</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <h5 style="color: black;">{{ business.B_name }}</h5>
                                            <div class="card-text-container">
                                                <div class="content-border">
                                                    <span class="field-name">توضیحات کسب‌وکار:</span>
                                                    <div class="content-row">
                                                        <p class="card-text editable"
                                                           data-field-name="description">{{ business.description }}</p>
                                                        {% if business.description %}
                                                            <span class="edit-icon"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% else %}
                                                            <span class="edit-icon empty"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-text-container">
                                                <div class="content-border">
                                                    <span class="field-name">شبکه اجتماعی:</span>
                                                    <div class="content-row">
                                                        <p class="card-text editable"
                                                           data-field-name="social_network">{{ business.social_network }}</p>
                                                        {% if business.social_network %}
                                                            <span class="edit-icon"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% else %}
                                                            <span class="edit-icon empty"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-text-container">
                                                <div class="content-border">
                                                    <span class="field-name">آدرس فروشگاه:</span>
                                                    <div class="content-row">
                                                        <p class="card-text editable"
                                                           data-field-name="shop_address">{{ business.shop_address }}</p>
                                                        {% if business.shop_address %}
                                                            <span class="edit-icon"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% else %}
                                                            <span class="edit-icon empty"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-text-container">
                                                <div class="content-border">
                                                    <span class="field-name">شماره تماس:</span>
                                                    <div class="content-row">
                                                        <p class="card-text editable"
                                                           data-field-name="B_phone">{{ business.B_phone }}</p>
                                                        {% if business.B_phone %}
                                                            <span class="edit-icon"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% else %}
                                                            <span class="edit-icon empty"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                                <div class="col-md-12">
                                    <form action="{% url 'sh:change_sorlink_url' sorlink_id=sorlink.id %}" method="post"
                                          id="sorlink_url_changer">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <div class="card-text-container">
                                                <div class="content-border">
                                                    <span class="field-name">آدرس سورلینک:</span>
                                                    <div class="content-row">
                                                        <p class="card-text editable"
                                                           data-field-name="new_url">{{ sorlink.ShortURL }}</p>
                                                        {% if sorlink.ShortURL %}
                                                            <span class="edit-icon"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% else %}
                                                            <span class="edit-icon empty"
                                                                  onclick="enableEditMode(this)"></span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            <div class="flex flex-row justify-center items-center gap-4 my-10">
                                <div class="col-md-12">
                                    <button class="inline-block w-full px-10 py-3 text-xs font-bold leading-normal text-center text-white capitalize transition-all ease-in rounded-lg shadow-md bg-slate-700 bg-150 hover:shadow-2xl hover:-translate-y-px" onclick="submitForms()">ثبت تغییرات</button>
                                </div>
                                <div class="col-md-12">
                                    <a
                                       href="{% url 'sh:redirect_function' sorlink.ShortURL %}" target="_blank">
                                        <button class="inline-block w-full px-8 py-3 text-xs font-bold leading-normal text-center text-white align-middle transition-all ease-in bg-blue-500 border-0 rounded-lg shadow-md select-none bg-150 bg-x-25 hover:shadow-xs hover:-translate-y-px">مشاهده سورلینک</button>
                                    </a>
                                </div>
                            </div>

                            </div>


                        </div>
                    </div>
                </div>

            {% endif %}
        {% endif %}
    </div>

    <script src="{% static 'js/cal/jquery-3.2.1.min.js' %}"></script>
    <script>
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').css('background-image', 'url(' + e.target.result + ')');
                    $('#imagePreview').hide();
                    $('#imagePreview').fadeIn(650);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imageUpload").change(function () {
            readURL(this);
            $("#profile-alert").hide();
        });

        function readURL2(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview2').css('background-image', 'url(' + e.target.result + ')');
                    $('#imagePreview2').hide();
                    $('#imagePreview2').fadeIn(650);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        $("#imageUpload2").change(function () {
            readURL2(this);
        });
    </script>
    <script>
        function enableEditMode(element) {
            const cardText = element.parentElement.querySelector('.card-text');
            const value = cardText.textContent;
            const fieldName = cardText.dataset.fieldName; // Get the name from 'data-field-name' attribute

            if (fieldName === 'description') {
                cardText.innerHTML = `<textarea name="${fieldName}" class="form-control">${value}</textarea>`;
            } else {
                cardText.innerHTML = `<input type="text" name="${fieldName}" value="${value}" class="form-control">`;
            }

            const inputField = cardText.querySelector('input') || cardText.querySelector('textarea');
            inputField.focus();
            inputField.addEventListener('blur', function () {
                cardText.innerHTML = inputField.value;
            });
        }

        function submitForms() {
            const form1 = document.getElementById("sorlink_changer");
            const form2 = document.getElementById("sorlink_url_changer");

            const formData1 = new FormData(form1);
            const formData2 = new FormData(form2);

            fetch(form1.action, {
                method: 'POST',
                body: formData1,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                })
                .catch((error) => {
                    console.error('Error submitting form 1:', error);
                });

            fetch(form2.action, {
                method: 'POST',
                body: formData2,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                })
                .catch((error) => {
                    console.error('Error submitting form 2:', error);
                });
        }

        // Function to get the CSRF token from cookies.
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    </script>
{% endblock %}
